---
title: "A Mixed-Effects Model for the Effect of Activating Factor 42 on Gene Expression in Wild-Type and 101-Type Cells"
author: "Athena Xiourouppa"
format: pdf
bibliography: references.bib
---

```{r, echo=FALSE}
pacman::p_load(tidyverse, gt)
knitr::opts_chunk$set(fig.pos = 'H')
```

# Introduction
The given dataset consists of 88 total observations of gene expression: 11 concentration levels 
from 0-10 mg/mL of 2 different treatments (Activating Factor 42 or Placebo) 
on 2 different cell types (101-Type or Wild-Type), with 
2 replications. Each set of 11 data points is labelled by the cell's gene line. 

We wish to develop a predictive model for the gene expression by investigating the 
effects of the predictors
gene line, cell type, treatment, all of which are categorical, and concentration of 
treatment, which is numeric and measured in milligrams per millilitre.

# Methods
## Cleaning
The data was provided as an Excel spreadsheet, which required some cleaning before 
being imported into RStudio[^1]. We did the following in Excel:

* Deleted the figures on pages `GL-CsE` and `GL-bNo`
* Removed the summary statistics on page `GL-CsE`
* Shifted data cells to top-left corner to avoid blank rows when reading into R
* Made cell line and treatment type names consistent
* Removed cell line and treatment type names from spreadsheet and copied separately. 
From there, we saved this as a new spreadsheet.

To import and analyse the data in R [@r2022], we used the packages `tidyverse` [@tidy2019],
`readxl` [@xl2023], `reshape2` [@reshape2007], `gt` [@gt2023], `lme4` [@lme2015], 
`ggrepel` [@ggrep2023], `paletteer` [@pale2021], and `performance` [@per2021] 
to work with tibbles, import an Excel spreadsheet, melt tibbles, create tables, create mixed effects models, label plots, colour plots, and obtain model metrics, respectively. 

Firstly, we obtained the names of each of the eight cleaned spreadsheets via the 
`excel_sheets` function. We then used `lapply` to save each individual sheet as a tibble 
and applied the corresponding name to each one. To keep track of the parameters used in 
each experiment, we then renamed the sheets so they had the format "GL-[Gene Line]-[Cell Type]-[Treatment]-[Trial]". The term 'Trial' is used loosely here to refer to experiments with the
same treatment and cell type, but the gene lines in these cases still differ, so they are 
not true replications.

There was a missing value in the JZC gene line trial, which we imputed with the mean value 
of the remaining ten values. Finally, we saved a cleaned version of the data as a `.csv` file 
for future use.

[^1]: https://www.rstudio.com

## Pre-processing
We melted the cleaned tibble by the concentration variable and then split the label 
into its four components by hyphen, using the `str_split` function, 
such that the gene line, cell type, treatment type, and 
trial number had separate columns. This was then saved as an additional `.csv` file.

## Choice of Model
Five models were considered in total, all of which used cell type, treatment type, and 
concentration of treatment as predictors. We justify this by the exploratory data analysis plot in 
@fig-eda, which shows differences in gene expression between cell type, treatment type, and 
concentration of treatment. 

```{r}
#| label: fig-eda
#| fig-cap: Plots showing the increase in gene expression as concentration of activating factor increases. We see that the Wild Type cells have a lower starting intercept value. We have also labelled the gene line for each set of eleven points.
knitr::include_graphics(here::here("figs", "2023-05-08-mixed-effects/model-eda.pdf"))
```

The gene line is effectively an identifier for each trial, so without multiple trials per gene line, we cannot use effectively interpret it as a predictor. However, 
we can consider the random effects that may result from differences between them. We used
the `lme4` [@lme2015] package to fit models and check assumption plots.

Each model used gene line as a random intercept effect, but changed the type of interaction between 
the three variables:

1. No interaction
2. Concentration of Treatment x Treatment Type
3. Treatment Type x Cell Type
4. Concentration of Treatment x Cell Type
5. Concentration of Treatment x Treatment Type x Cell Type

We compared these three models by their residuals vs fitted plots, AIC, RMSE, and $R^2$, using the 
`performance` [@per2021]  package.

# Results
Upon looking at the residuals vs fitted plots, only the second and fifth models satisfied the assumption of homoscedasticity, so we discarded the other models. The plot for the second model is shown in Figure @fig-m2res, and is very similar to that of the fifth model, hence why it is not shown. 
```{r}
#| label: fig-m2res
#| fig-cap: Residuals versus fitted plot for the second model, which varies intercept by gene line and considers interaction between concentration of treatment and treatment type. We see there is random scattering of the residuals, satisfying the assumption of homoscedasticity.
knitr::include_graphics(here::here("figs", "2023-05-08-mixed-effects/model2-assumptions.pdf"))
```

@tbl-comp shows the comparison of the Root Mean Square Error (RMSE) metric, $R^2$ metric, and AIC metric for our two models, as well as their degrees of freedom. We have chosen Model 2, since it has fewer degrees of freedom, and is only slightly different from Model 5. 
```{r, echo=FALSE}
#| label: tbl-comp
#| tbl-cap: Quantitative metrics for the two models. We see that the three-way interaction model has a much lower AIC than the Concentration x Treatment model, but the RMSE and $$R^2$$ are both quite similar. Given that the three-way interaction model has more degrees of freedom, we have chosen the Concentration x Treatment.
htmltools::includeHTML(here::here("tabs", "2023-05-08-mixed-effects/model-metrics.html"))
```

@fig-plot shows the fit of the linear mixed effect model to the data, separated by cell type.
```{r, echo=FALSE}
#| label: fig-plot
#| fig-cap: Plot of gene expression versus concentration of treatment factor for the two cell types and two treatment factors, indicated by shape and colour, respectively. We have also labelled the gene lines at their final observations. We notice that the Wild Type cells have a lower starting intercept compared with the 101 Type cells. The linear model fits the Wild Type cells more accurately than the 101 Type cells, and the same applies for the placebo treatment versus than Activating Factor 42. 
#| width: 80%
knitr::include_graphics(here::here("figs/2023-05-08-mixed-effects/model-plot.pdf"), dpi=400)
```

@tbl-coef shows the coefficients of our final model.
```{r, echo=FALSE}
#| label: tbl-coef
#| fig-cap: Coefficients of the chosen model. We notice the variation in intercept across gene lines is not particularly large, with the exception of Rza and xpo, which fall out of the 10-13 gene expression units that the other gene lines satisfy. The slope is just under 3 gene expression units, we subtract almost 5 units from the intercept if placebo treatment is used and roughly 3.3 units if we apply treatment to a Wild Type cell. We also subtract 1.9 units from the the slope if placebo treatment is used, indicating that 101 Type cells with Activating Factor 42 applied exhibit the greatest gene expression.

htmltools::includeHTML(here::here("tabs", "2023-05-08-mixed-effects/m2-coefs.html"))
```

# Discussion
From @fig-plot, we see that applying Activating Factor 42 increases the slope, so for an increase of 1 mg/mL of treatment, gene expression subsequently increases for this treatment. Similarly, we mostly see greater gene expression for 101 Type Cells, also evident by the subtractive term in @tbl-coef. The bNo and CsE gene lines have the most variability about the line of best fit from our model, but other gene lines are fitted more accurately. This could likely be due to the fact that the placebo treatment has limited effect on gene expression, so this is simply natural variation.

The chosen model has an RMSE of approximately $1.49$ gene expression units, which is smaller than the 
mean gene expression of $17.53$, and a high $R^2$ value of $97.9\%$, meaning just under $98\%$ of the 
variation in gene expression is explained by our model. This could also be indicative of overfitting. To further justify the validity of the model, error bounds on the equipment used to measure gene expression should be provided so they can be 
accounted for by the model.

# Bibliograhy


